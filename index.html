<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="utf-8"/>
  <title>CityMap</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <link rel="manifest" href="manifest.json">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <style>
    html, body, #map { height: 100%; margin: 0; }

    .toolbar{
      position:absolute; top:10px; left:60px; z-index:2000;
      background: rgba(255,255,255,.92);
      padding: 8px; border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,.18);
      display:flex; gap:8px; align-items:center;
    }
    .btn{
      border:0; padding:10px 12px; border-radius:12px;
      cursor:pointer; font-weight:700;
    }
    .btn-add{ background:#2c7be5; color:#fff; }
    .btn-loc{ background:#16a34a; color:#fff; }
    .btn-clear{ background:#ef4444; color:#fff; }
.btn-filter{ background:#6b7280; color:#fff; }
.table-scroll {
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        overflow: auto; /* vertical + horizontal */
        max-height: 360px; /* only the table area scrolls */
        background: #fff;
      }
.table-scroll thead th{ background: #fff; }
.filter-table {
        border-collapse: collapse;
        width: max-content; /* allow horizontal scroll when needed */
        min-width: 100%;
      }
.filter-table th,
      .filter-table td {
        border: 1px solid #e5e7eb;
        padding: 8px 10px;
        font-size: 14px;
        vertical-align: top;
        white-space: nowrap; /* horizontal scroll instead of wrapping */
        background: #fff;
      }
      .filter-table thead th {
        position: sticky;
        top: 0;
        z-index: 2;
        background: #f9fafb;
      }

	.filter-table tbody tr{ cursor: pointer; }
	/* A celláknak külön fehér háttere van, ezért a hover/kijelölés is a TD-ken legyen */
	.filter-table tbody tr:hover td{ background: #f3f4f6; }
	.filter-table tbody tr.row-selected td{ background: #dbeafe; }
	.filter-table tbody tr.row-deleted td{ color:#6b7280; text-decoration: line-through; background:#f9fafb; }
	.filter-table tbody tr.row-selected.row-deleted td{ text-decoration: line-through; }
#filterModal .modal-content{
  max-height: 90vh;
  display: flex;
  flex-direction: column;
  overflow: hidden; /* ne lógjanak ki a gombok kis kijelzőn */
}
#filterModal .table-scroll{
  flex: 1 1 auto;
  min-height: 0; /* fontos: így csak itt lesz scroll */
  margin-top: 12px;
  overflow: auto; /* vertical + horizontal */
}

/* Szűrés ablak gombok: ha nem fér ki egy sorba, törjön */
#filterModal .modal-actions{ flex-wrap: wrap; }
    #appVersion{
      position:fixed; left:8px; bottom:8px; z-index:1200;
      background: rgba(255,255,255,.86);
      padding: 4px 10px; border-radius: 10px;
      font: 12px system-ui, -apple-system, Segoe UI, Roboto, Arial;
      box-shadow: 0 2px 8px rgba(0,0,0,.14);
    }
    #hint{
      position:fixed; left:10px; top:60px; z-index:1200;
      background: rgba(0,0,0,.65); color:#fff;
      padding: 8px 10px; border-radius: 12px;
      font: 13px system-ui, -apple-system, Segoe UI, Roboto, Arial;
      display:none;
      max-width: calc(100vw - 20px);
    }

    /* Modal */
    .modal{
      position:fixed; inset:0; z-index:2000;
      background: rgba(0,0,0,.45);
      display:none; align-items:center; justify-content:center;
    }
    .modal-content{
      width: min(380px, calc(100vw - 24px));
      background:#fff; border-radius: 16px; padding: 16px;
      box-shadow: 0 12px 28px rgba(0,0,0,.25);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }

    /* Settings modal (Edge-szerű elrendezés) */
    #settingsModal .settings-modal{
      width: min(980px, calc(100vw - 24px));
      height: min(82vh, calc(100vh - 24px));
      padding: 0;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    #settingsModal .settings-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding: 14px 16px;
      border-bottom: 1px solid #e5e7eb;
      background: #fff;
    }
    #settingsModal .settings-shell{
      display:flex;
      flex: 1 1 auto;
      min-height: 0;
    }
    #settingsModal .settings-nav{
      width: 240px;
      background: #f3f4f6;
      border-right: 1px solid #e5e7eb;
      padding: 10px;
      display:flex;
      flex-direction:column;
      gap:8px;
      overflow:auto;
    }
    #settingsModal .settings-nav-item{
      text-align:left;
      border:0;
      background: transparent;
      padding: 10px 12px;
      border-radius: 12px;
      cursor:pointer;
      font-weight: 700;
      color:#111827;
    }
    #settingsModal .settings-nav-item:hover{ background:#e5e7eb; }
    #settingsModal .settings-nav-item.active{ background:#111827; color:#fff; }
    #settingsModal .settings-content{
      flex: 1 1 auto;
      min-width: 0;
      padding: 16px;
      /* A jobb oldali tartalom legyen rugalmas, a táblázat töltse ki a rendelkezésre álló helyet */
      display:flex;
      flex-direction:column;
      overflow:hidden;
      background: #fff;
    }

    /* A dinamikus tartalom (settingsExtra) töltse ki a jobb oldali panel magasságát */
    #settingsExtra{
      flex: 1 1 auto;
      min-height: 0;
      display:flex;
      flex-direction:column;
    }

    /* v5.21: Objektum típusa táblázat scroll (függőleges + vízszintes) */
    #settingsModal .settings-table-wrap{
      flex: 1 1 auto;
      min-height: 0;
      max-height: none;
      overflow: auto; /* vertical + horizontal */
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      background: #fff;
    }

    /* v5.22.1: Excel-szerű színválasztó (popover) */
    .color-cell{ display:flex; align-items:center; justify-content:flex-start; }
    .color-btn{
      display:flex; align-items:center; gap:8px;
      width: 100%;
      border:1px solid #d1d5db;
      border-radius: 12px;
      padding: 8px 10px;
      background:#fff;
      cursor:pointer;
      font-weight: 700;
    }
    .color-btn:hover{ background:#f9fafb; }
    .color-dot{ width:18px; height:18px; border-radius: 6px; border:1px solid rgba(0,0,0,.15); flex: 0 0 auto; }
    .color-hex{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 12px; color:#111827; }

    /* v5.23.2: közvetlen "Színek szerkesztése" ablak (Excel/Windows hangulat) */
    .colors-editor-overlay{
      position: fixed;
      inset: 0;
      display:flex;
      align-items:center;
      justify-content:center;
      background: rgba(0,0,0,.35);
      z-index: 5000;
      padding: 14px;
    }
    .colors-editor{
      width: min(900px, 96vw);
      max-height: 88vh;
      background:#fff;
      border-radius: 14px;
      border:1px solid #e5e7eb;
      box-shadow: 0 18px 60px rgba(0,0,0,.35);
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }
    .colors-editor-titlebar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 12px 14px;
      border-bottom: 1px solid #e5e7eb;
      background:#f9fafb;
    }
    .colors-editor-title{ font-weight: 900; font-size: 26px; }
    .colors-editor-x{
      width: 40px; height: 40px;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      background:#fff;
      cursor:pointer;
      font-size: 22px;
      line-height: 1;
    }
    .colors-editor-main{
      display:flex;
      gap: 18px;
      padding: 14px;
      overflow: auto;
    }
    .ce-left{ flex: 1 1 auto; min-width: 360px; }
    .ce-right{ width: min(320px, 100%); display:flex; flex-direction:column; gap:10px; }
    .ce-picker{ display:flex; gap:12px; align-items:stretch; }
    .ce-sv{
      position: relative;
      width: min(520px, 100%);
      height: 260px;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      overflow:hidden;
      cursor: crosshair;
    }
    .ce-sv-white{ position:absolute; inset:0; background: linear-gradient(to right, #fff, rgba(255,255,255,0)); }
    .ce-sv-black{ position:absolute; inset:0; background: linear-gradient(to top, #000, rgba(0,0,0,0)); }
    .ce-sv-cursor{
      position:absolute;
      width: 16px; height: 16px;
      border-radius: 999px;
      border: 2px solid #fff;
      box-shadow: 0 0 0 1px rgba(0,0,0,.55);
      transform: translate(-8px, -8px);
      pointer-events:none;
    }
    .ce-bars{ display:flex; gap:10px; }
    .ce-bar{
      position: relative;
      width: 30px;
      height: 260px;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      overflow:hidden;
      cursor:pointer;
    }
    .ce-hue{ background: linear-gradient(to bottom, #ff0000, #ffff00, #00ff00, #00ffff, #0000ff, #ff00ff, #ff0000); }
        .ce-bar-cursor{
      position:absolute;
      left: 50%;
      width: 20px; height: 20px;
      border-radius: 999px;
      border: 3px solid #fff;
      box-shadow: 0 0 0 1px rgba(0,0,0,.55);
      transform: translate(-50%, -50%);
      pointer-events:none;
    }

    .ce-hex{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-weight: 800; }
    .ce-mode{ width: 100%; }
    .ce-rgb{ display:flex; flex-direction:column; gap:10px; }
    .ce-rgb-row{ display:flex; gap:10px; align-items:center; }
    .ce-rgb-row input{ width: 120px; }
    .ce-rgb-row span{ font-weight: 700; color:#111827; }
    .ce-preview{ margin-top: 6px; display:flex; flex-direction:column; gap:12px; }
    .ce-preview-box{ display:flex; gap:10px; align-items:center; }
    .ce-preview-swatch{ width: 64px; height: 44px; border-radius: 12px; border:1px solid rgba(0,0,0,.18); background:#fff; }
    .ce-preview-label{ font-weight: 800; color:#111827; }
    .ce-preview-hex{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 12px; color:#6b7280; font-weight: 800; }

    .colors-editor-bottom{ padding: 10px 14px 14px 14px; }
    .ce-section{ margin-top: 10px; }
    .ce-section-title{ display:flex; align-items:center; justify-content:space-between; font-weight: 900; margin: 8px 0; }
        .ce-base{ display:grid; gap: 8px; grid-template-columns: repeat(auto-fill, minmax(26px, 1fr)); }
    .ce-swatch{ width: 26px; height: 26px; border-radius: 6px; border: 1px solid rgba(0,0,0,.18); cursor:pointer; background:#fff; }
    .ce-swatch:hover{ outline: 2px solid rgba(17,24,39,.35); }
    
    .colors-editor-actions{
      display:flex;
      gap: 10px;
      justify-content: flex-start;
      padding: 14px;
      border-top: 1px solid #e5e7eb;
      background:#f9fafb;
    }

    @media (max-width: 980px){
      .colors-editor-main{ flex-direction: column; }
      .ce-left{ min-width: 0; }
      .ce-bar, .ce-sv{ height: 220px; }
      .ce-base{ grid-template-columns: repeat(auto-fill, minmax(24px, 1fr)); }
    }
    @media (max-width: 560px){
      .ce-bar{ width: 38px; }
      .ce-base{ grid-template-columns: repeat(auto-fill, minmax(22px, 1fr)); }
      .colors-editor-title{ font-size: 22px; }
    }

    @media (max-width: 720px){
      #settingsModal .settings-shell{ flex-direction: column; }
      #settingsModal .settings-nav{ width: auto; border-right: 0; border-bottom: 1px solid #e5e7eb; flex-direction: row; }
      #settingsModal .settings-nav-item{ flex: 1 1 0; text-align:center; }
    }
    .row{ display:flex; gap:10px; }
    label{ display:block; margin-top: 10px; font-size: 13px; color:#111827; }
    input, select, textarea{
      width:100%; box-sizing:border-box;
      margin-top:6px; padding:10px;
      border:1px solid #d1d5db; border-radius: 12px;
      font-size: 14px;
    }
    textarea{ min-height: 70px; resize: vertical; }
    .small{ font-size: 12px; color:#6b7280; margin-top:6px; }

    .modal-actions{
      display:flex; justify-content:flex-end; gap:10px;
      margin-top: 14px;
    }

    /* v5.11: marker modal actions: photo button left, cancel/save right */
    .modal-actions.marker-actions{ justify-content: space-between; align-items: center; flex-wrap: wrap; }
    .modal-actions.marker-actions .left-actions,
    .modal-actions.marker-actions .right-actions{ display:flex; gap:10px; align-items:center; }
    /* On narrow screens keep buttons readable */
    .modal-actions.marker-actions .left-actions{ flex: 1 1 auto; }
    .btn-ghost{ background:#f3f4f6; color:#111827; }
    .btn-save{ background:#111827; color:#fff; }

    /* Photo gallery */
    .photo-grid{
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap:10px;
      max-height: min(60vh, 520px);
      overflow:auto;
      padding:2px;
    }
    .photo-item{
      position:relative;
    }
    .photo-empty{
      color:#6b7280;
      padding:8px;
      font-size:14px;
    }
    .photo-delete{
      position:absolute;
      top:8px;
      right:8px;
      border:1px solid rgba(0,0,0,0.15);
      background: rgba(255,255,255,0.92);
      color:#111827;
      font-size:12px;
      padding:6px 8px;
      border-radius:10px;
      cursor:pointer;
      box-shadow: 0 2px 8px rgba(0,0,0,0.12);
    }
    .photo-delete:hover{ background:#fff; }
    .photo-delete:active{ transform: translateY(1px); }
    .photo-item img{
      width:100%;
      height:120px;
      object-fit:cover;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      background:#fff;
    }
    .photo-item .meta{
      font-size:12px;
      color:#6b7280;
      margin-top:6px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
  
  /* Filter table row selection */
  #sfTable tbody tr.selected { background: rgba(0, 123, 255, 0.15); }
  .btn:disabled { opacity: 0.55; cursor: not-allowed; }
</style>
</head>

<body>
  <div class="toolbar">
    <button class="btn btn-add" id="btnAdd">Objektum hozzáadása</button>
    <button class="btn btn-filter" id="btnFilter">Szűrés</button>
    <button class="btn btn-filter" id="btnShowAll" style="display:none;">Összes megjelenítése</button>
    <button class="btn btn-filter" id="btnSettings">Beállítások</button>
    <button class="btn btn-loc" id="btnMyLoc">Saját helyem</button>
    <button class="btn btn-clear" id="btnClear">Összes törlése</button>
  </div>

  <div id="map"></div>
  <div id="appVersion">v0.0.0</div>
  <div id="hint"></div>

  <div id="markerModal" class="modal">
    <div class="modal-content">
      <h3 id="markerModalTitle" style="margin:0 0 6px 0;">Objektum rögzítése</h3>
      <div id="markerModalHint" class="small">Bökés helyén jön létre, utána húzással finomítható.</div>

      <label>Város</label>
      <input id="fCity" placeholder="pl. Oroszlány">

      <label>Közterület név, típus</label>
      <input id="fStreet" placeholder="pl. Arany János utca">

      <label>Házszám</label>
      <input id="fHouse" placeholder="pl. 12">

      <div class="row">
        <div style="flex:1">
          <label>Típus</label>
          <select id="fType"></select>
        </div>
        <div style="flex:1">
          <label>Állapot</label>
          <select id="fStatus"></select>
        </div>
      </div>

      <label>Megjegyzés (opcionális)</label>
      <textarea id="fNotes" placeholder="pl. festés kopott, csavar hiányzik..."></textarea>

      <div class="modal-actions marker-actions">
        <div class="left-actions">
          <button class="btn btn-ghost" id="btnAttachPhoto" type="button">Fénykép hozzárendelése (0)</button>
          <input id="photoInput" type="file" accept="image/*" multiple capture="environment" style="display:none" />
        </div>
        <div class="right-actions">
          <button class="btn btn-ghost" id="btnCancel">Mégse</button>
          <button class="btn btn-save" id="btnSave">Mentés</button>
        </div>
      </div>
    </div>
  </div>

  
  <div id="filterModal" class="modal">
    <div class="modal-content">
      <h3 style="margin:0 0 6px 0;">Szűrés</h3>

      <label>Cím</label>
      <input id="sfAddress" placeholder="Cím részlet">

      <div class="row">
        <div style="flex:1">
          <label>Típus</label>
          <select id="sfType"></select>
        </div>
        <div style="flex:1">
          <label>Állapot</label>
          <select id="sfStatus"></select>
        </div>
      </div>

      <div class="table-scroll" id="sfTableScroll">
        <table class="filter-table" id="sfTable">
          <colgroup>
            <col style="width:6%">
            <col style="width:16%">
            <col style="width:38%">
            <col style="width:12%">
            <col style="width:12%">
            <col style="width:16%">
          </colgroup>
          <thead>
            <tr>
              <th></th>
              <th>ID</th>
              <th>Cím</th>
              <th>Típus</th>
              <th>Állapot</th>
              <th>Megjegyzés</th>
            </tr>
          </thead>
          <tbody id="sfList"></tbody>
        </table>
      </div>

      <div class="modal-actions">
        <button class="btn btn-ghost" id="filterClearSelectionBtn" disabled>Kijelölés megszüntetése</button>
        <button class="btn btn-danger" id="filterDeleteSelectedBtn" disabled>Kijelöltek törlése</button>
        <button class="btn btn-ghost" id="filterPhotosBtn" disabled>Fotók</button>
        <button class="btn btn-ghost" id="filterEditBtn" disabled>Objektum módosítása</button>
        <button class="btn btn-save" id="filterShowBtn" disabled>Megjelenítés</button>
        <button class="btn btn-ghost" id="filterShowDeletedBtn">Töröltek megjelenítése</button>
        <button class="btn btn-ghost" id="btnFilterClose">Bezár</button>
      </div>
    </div>
  </div>

  <div id="settingsModal" class="modal">
    <div class="modal-content settings-modal">
      <div class="settings-header">
        <div style="font-weight:800; font-size:20px;">Beállítások</div>
        <button class="btn btn-ghost" id="btnSettingsClose" type="button">Bezár</button>
      </div>

      <div class="settings-shell">
        <div class="settings-nav">
          <button class="settings-nav-item" data-page="type">Objektum típusa</button>
          <button class="settings-nav-item" data-page="status">Objektum állapota</button>
          <button class="settings-nav-item" data-page="users">Felhasználó kezelés</button>
        </div>

        <div class="settings-content" id="settingsContent">
          <h3 id="settingsTitle" style="margin:0 0 10px 0;">Objektum típusa</h3>
          <div class="small" id="settingsHint">Itt később a típusok kezelése (adatbázis, színek, bővítés/módosítás) lesz elérhető.</div>
          <div id="settingsExtra"></div>
        </div>
      </div>
    </div>
  </div>

  <div id="photoGalleryModal" class="modal">
    <div class="modal-content" style="max-width: 760px;">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;">
        <h3 style="margin:0;">Fotók</h3>
        <button class="btn btn-ghost" id="btnPhotoGalleryCloseTop" type="button">Bezár</button>
      </div>
      <div id="photoGalleryMeta" style="margin:8px 0 12px 0; color:#555;"></div>
      <div id="photoGalleryGrid" class="photo-grid"></div>
      <div class="modal-actions" style="justify-content:flex-end;">
        <button class="btn btn-ghost" id="btnPhotoGalleryClose">Bezár</button>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="db.js"></script>
  <script src="app.js"></script>
</body>
</html>

